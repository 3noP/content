commonfields:
  id: GetByIncidentId
  version: -1
name: GetByIncidentId
script: |
  from functools import reduce


  def get_by_incident_id(incident_id, get_key, set_key=""):
      set_key = get_key if not set_key else set_key
      keys = get_key.split('.')

      try:
          context = demisto.executeCommand("getContext", {"id": incident_id})[0]['Contents']['context']
          res = reduce(lambda x, y: x[y], keys, context)
      except:
          error_msg = "Cannot find {} in incident #{}".format(get_key, incident_id)
          return_error(message=error_msg,
                       error='GetByIncidentId: ' + error_msg,
                       outputs={set_key: error_msg})

      entry_context = {set_key: res}

      return_outputs(
          readable_output="Key '{}' successfully retrieved and set into current incident at '{}'.".format(get_key,
                                                                                                          set_key),
          outputs=entry_context)


  def main():
      inc_id = demisto.args().get('incident_id', demisto.incidents()[0]['id'])
      get_k = demisto.args()['get_key']
      set_k = demisto.args().get('set_key', get_k)

      get_by_incident_id(inc_id, get_k, set_k)


  if __name__ == "__builtin__" or __name__ == "builtins":
      main()
type: python
tags: []
comment: Gets a value from the given incident's context.
enabled: true
args:
- name: incident_id
  default: true
  description: Incident to get context values from (Default is current incident)
- name: get_key
  required: true
  description: The key to get
- name: set_key
  description: The key to set (will default to get_key)
scripttarget: 0
runonce: false
dockerimage: demisto/python3:3.7.4.1900
runas: DBotWeakRole
